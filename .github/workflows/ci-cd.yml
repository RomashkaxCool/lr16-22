name: CI/CD

# Запускати пайплайн, коли робимо push у гілку main
on:
  push:
    branches: ["main"]
  # Також запускати при створенні Pull Request у main
  pull_request:
    branches: ["main"]

jobs:
  lint:
    name: Lint (black, isort, flake8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install linters
        run: |
          pip install black isort flake8
      - name: Run Black
        run: black --check .
      - name: Run Isort
        run: isort --profile black --check-only .
      - name: Run Flake8
        run: flake8 --exclude=venv,env,migrations

  tests:
    name: Tests + Coverage
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Run tests
        run: pytest --cov=src --cov-report=xml --cov-fail-under=30
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.xml

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Deploy Hook
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "RENDER_DEPLOY_HOOK not set"
            exit 1
          fi
          curl -X POST "$RENDER_DEPLOY_HOOK"

  healthcheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Wait for service to be healthy
        env:
          HEALTHCHECK_URL: ${{ secrets.RENDER_HEALTHCHECK_URL }}
        run: |
          echo "Waiting for deployment..."
          # Чекаємо до 5 хвилин (30 спроб * 10 сек)
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTHCHECK_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Service is healthy!"
              exit 0
            fi
            echo "Waiting... Status: $STATUS"
            sleep 10
          done
          echo "Healthcheck failed after timeout"
          exit 1
